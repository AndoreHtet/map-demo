<!DOCTYPE html>
<html th:replace="layouts/masterLayout :: layout(~{::main})" xmlns:th="http://www.thymeleaf.org">

<link rel="stylesheet" href="../../static/bootstrap/css/bootstrap.min.css"
      th:href="@{/bootstrap/css/bootstrap.min.css}">

<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />



<body>
<main role="main">



    <div class="container" style="position: relative;">
        <button class="btn btn-success mb-1 mt-3" onclick="fetchAllCustomers()">Find All Customers</button>
        <div id="customer_map" style="width: 100%;z-index: 1; height: 400px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);  border: 1px solid #ccc; margin-top: 20px; position: fixed; margin-bottom: 20px;"></div>
    </div>


    <div class="container" style="margin-top: 2rem;">


        <!-- Search box for filtering customers -->
        <div class="input-group mb-3">
            <input type="text" id="customerSearch" class="form-control" placeholder="Search for customers">
            <button class="btn btn-primary" type="button" onclick="searchCustomers()">Search</button>
        </div>

            <div class="row">
                <div class="col">
                    <div class="card">
                        <div class="card-header">
                            <h2>Customer List</h2>
                        </div>
        <!-- Display customer table here -->
                        <table id="customerTable" class="table table-striped table-responsive">
                            <thead class="thead-dark">
                                <tr>
                                    <th scope="col">Name</th>
                                     <th scope="col">Email</th>
                                     <th scope="col">Phone</th>
                                    <th scope="col">Action</th>
                                </tr>
                            </thead>
                            <tbody>
            <!-- Customer data will be filled here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
    </div>


    <script th:inline="javascript">

        var map;
        var markers = [];

        async function initMap() {
            map = new google.maps.Map(document.getElementById('customer_map'), {
                center: { lat: 0, lng: 0 },
                zoom: 12
            });

            // Fetch all customer data initially
            fetchAllCustomers();
        }

        $(document).ready(function() {
            // Autocomplete functionality
            $('#customerSearch').on('input', function() {
                var searchTerm = $(this).val().toLowerCase();
                if (searchTerm.length > 0) {
                    $.get('/customers/autocomplete?searchTerm=' + searchTerm, function(data) {
                        // Clear existing table rows
                        $('#customerTable tbody').empty();
                        // Append matched customer data to table
                        data.forEach(function(customer) {
                            $('#customerTable tbody').append('<tr><td>' + customer.name + '</td><td>' + customer.email + '</td><td>' + customer.phone + '</td><td><a href="#" class="btn btn-primary btn-sm" onclick="viewCustomerDetail(' + customer.id + ')">Detail</a></td></tr>');
                        });
                    });
                } else {
                    // If input is empty, fetch all customers
                    fetchAllCustomers();
                }
            });
        });

        function fetchAllCustomers() {
            $.get("/customers/customer-list", function(data) {
                removeAllMarkers();
                displayCustomers(data);

                if (Array.isArray(data) && data.length > 0) {
                    var bounds = new google.maps.LatLngBounds();

                    data.forEach(function(customer) {
                        if (customer.addresses && Array.isArray(customer.addresses)) {
                            customer.addresses.forEach(function(address) {
                                if (address.latitude && address.longitude) {
                                    var coordinates = { lat: address.latitude, lng: address.longitude };
                                    placeMarker(coordinates, customer.name);
                                    bounds.extend(coordinates);
                                } else {
                                    console.error("Invalid latitude or longitude for address:", address.id);
                                }
                            });
                        } else {
                            console.error("No addresses found for customer:", customer.name);
                        }
                    });

                    map.fitBounds(bounds);
                    map.panToBounds(bounds);
                } else {
                    console.error("No customers found in the response.");
                }
            }).fail(function() {
                console.error("Failed to fetch all customers data.");
            });
        }

        function searchCustomers() {
            var searchTerm = $("#customerSearch").val().toLowerCase();
            $.get("/customers/found-customer?name=" + searchTerm, function(data) {
                displayCustomers(data);
                if (Array.isArray(data) && data.length > 0) {
                    var bounds = new google.maps.LatLngBounds();
                    removeAllMarkers();

                    data.forEach(function(customer) {
                        if (customer.addresses && Array.isArray(customer.addresses)) {
                            customer.addresses.forEach(function(address) {
                                if (address.latitude && address.longitude) {
                                    var coordinates = { lat: address.latitude, lng: address.longitude };
                                    placeMarker(coordinates, customer.name);
                                    bounds.extend(coordinates);
                                } else {
                                    console.error("Invalid latitude or longitude for address:", address.id);
                                }
                            });
                        } else {
                            console.error("No addresses found for customer:", customer.name);
                        }
                    });


                    var predefinedZoomLevel = 18;
                    map.setZoom(predefinedZoomLevel);

                    // Center the map at the first customer's location
                    var firstCustomer = data[0];
                    if (firstCustomer && firstCustomer.addresses && firstCustomer.addresses.length > 0) {
                        var firstAddress = firstCustomer.addresses[0];
                        var centerCoordinates = { lat: firstAddress.latitude, lng: firstAddress.longitude };
                        map.setCenter(centerCoordinates);
                    }
                } else {
                    console.error("No customers found matching the search term.");
                }
            }).fail(function() {
                console.error("Failed to fetch filtered customers.");
            });
        }




        function displayCustomers(customers) {
            // Clear existing table rows
            $('#customerTable tbody').empty();
            // Append customer data to table
            customers.forEach(function(customer) {
                $('#customerTable tbody').append('<tr><td>' + customer.name + '</td><td>' + customer.email + '</td><td>' + customer.phone + '</td><td><a href="#" class="btn btn-primary btn-sm" onclick="viewCustomerDetail(' + customer.id + ')">Detail</a></td></tr>');
            });
        }

        function viewCustomerDetail(customerId) {
            window.location.href = '/customer-detail?id=' + customerId;
        }

        function placeMarker(location, name) {
            var marker = new google.maps.Marker({
                position: location,
                map: map,
                title: name
            });
            markers.push(marker);
        }

        function removeAllMarkers() {
            markers.forEach(function(marker) {
                marker.setMap(null);
            });
            markers = [];
        }

        $(window).on('load', function() {
            initMap();
        });
    </script>

</main>
</body>

</html>